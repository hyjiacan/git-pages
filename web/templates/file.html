<!DOCTYPE html>
<html lang="en">
<head>
  <title>{{userName}}/{{projectName}} - {{$config.name}} - {{$config.description}}</title>
  <t-include file="include/assets.html"/>
  <script src="/static/lib/timeago.js/timeago.min.js"></script>
  <t-if on="/^\.(md|markdown|txt|text)$/i.test(ext)">
    <script src="/static/lib/highlightjs/js/highlight.pack.min.js"></script>
    <script src="/static/lib/marked/marked.min.js"></script>
    <link href="/static/lib/highlightjs/styles/solarized-light.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/static/styles/markdown.css"/>
  </t-if>
  <t-elif on="/^\.pdf$/i.test(ext)">
    <script src="/static/lib/pdfobject/pdfobject.min.js"></script>
  </t-elif>
  <style>
  #container {
      position: relative;
  }

  #container:after {
      content: ' ';
      clear: both;
      display: block;
  }

  #sidebar {
      float: left;
      width: 360px;
  }

  #catalog {
      font-size: small;
      border-left: 1px dotted #5f6371;
      list-style: none;
      margin: 0;
      padding: 0;
  }

  #catalog ul {
      list-style: none;
      margin: 0;
      padding: 0;
      border-left: 1px dotted transparent;
  }

  #catalog ul:hover {
      border-left-color: #5f6371;
  }

  #catalog li {
      padding: 5px 0 0 20px;
  }

  #catalog > li {
      padding-left: 5px;
  }

  #content {
      margin-left: 370px;
      overflow: auto;
      font-size: 13px;
  }

  .item-content {
      width: 100%;
  }

  .item-content .fa {
      color: rgba(95, 99, 113, 0.8);
      vertical-align: middle;
      display: inline-block;
      width: 18px;
      text-align: center;
  }

  .item-content:hover .fa {
      color: rgb(67, 73, 92);
  }

  .item-content a {
      color: #015aba;
      vertical-align: middle;
  }

  .item-content.active a,
  .item-content.active .fa {
      color: #0a7e2d;
      font-weight: bold;
  }

  img {
      max-width: 100%;
  }

  span[data-user] {
      text-transform: uppercase;
      color: #e30071;
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 14px;
      vertical-align: 0;
      text-align: center;
      cursor: default;
      font-size: 12px;
      font-weight: bold;
      background-color: #eaeaea;
      border: 1px solid #aeaeae;
      border-radius: 50%;
  }

  span[data-date] {
      vertical-align: middle;
  }

  .data-msg {
      width: 100%;
      color: #555555;
      font-size: 12px;
      text-overflow: ellipsis;
      overflow: hidden;
      word-break: keep-all;
      white-space: nowrap;
      padding-left: 2px;
  }

  .data-msg .badge {
      font-weight: normal;
      background-color: #eaeaea;
      line-height: 1.4;
  }
  </style>
</head>
<body>
<!--<div class="{{isReadme ? 'container' : 'container'}}">-->
<div class="container">
  <t-include file="include/header.html"/>
  <nav aria-label="breadcrumb" class="position-relative">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="/">
          <i class="fa fa-home"></i>
        </a>
      </li>
      <li class="breadcrumb-item">
        <a href="/projects/">项目</a>
      </li>
      <li class="breadcrumb-item">
        <a href="/projects/{{userName}}/">{{userName}}</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">{{projectName}}</li>
      <li class="breadcrumb-item">
        {{decodeURI(file).split('/').pop()}}
      </li>
    </ol>
    <div class="position-absolute" style="right: 10px;top: 12px;">
      <a href="{{editUrl}}" target="_blank" class="mr-2">
        <i class="fa fa-edit"></i>
        <span>编辑</span>
      </a>
      <a href="/raw/{{userName}}/{{projectName}}/{{decodeURI(file)}}?download" target="_blank">
        <i class="fa fa-download"></i>
        <span>下载</span>
      </a>
    </div>
  </nav>
  <div class="mb-2">
    <div class="float-left">
      <span>
        <i class="fa fa-book"></i>
        <span>{{$project.repository.description}}</span>
      </span>
    </div>
    <div class="float-right">
      <t-if on="isReadme">
        <span class="badge badge-light">
          <img src="{{$project.pusher.avatar_url}}" alt="{{$project.pusher.username}}" width="20"/>
          <span>{{$project.pusher.full_name}}</span>
          <span>更新于</span>
          <span datetime="{{$project.repository.updated_at}}"></span>
        </span>
      </t-if>
      <t-else>
        <span class="badge badge-light">
          <span id="update-user"></span>
          <span>更新于</span>
          <span id="update-date"></span>
        </span>
      </t-else>
    </div>
    <span class="clearfix"></span>
  </div>
  <hr>
  <div id="container">
    <t-if on="!isReadme">
      <div id="sidebar">
        <ul id="catalog">
          <t-tree on="catalog as item">
            <li>
              <div class="item-content d-inline-block">
                <t-if on="item.type === 'dir'">
                  <i class="fa fa-folder-o"></i>
                  <span class="text-wrap">{{item.name}}</span>
                </t-if>
                <t-else>
                  <t-if on="/^\.(md|markdown)$/i.test(item.ext)">
                    <i class="fa fa-file-code-o"></i>
                  </t-if>
                  <t-elif on="/^\.docx$/i.test(item.ext)">
                    <i class="fa fa-file-word-o"></i>
                  </t-elif>
                  <t-elif on="/^\.pdf$/i.test(item.ext)">
                    <i class="fa fa-file-pdf-o"></i>
                  </t-elif>
                  <t-else>
                    <i class="fa fa-file-text-o"></i>
                  </t-else>
                  <a href="/projects/{{userName}}/{{projectName}}/{{item.file}}" class="text-wrap">
                    {{item.name}}
                  </a>
                  <div class="data-msg">
                    <span data-user="{{item.meta.user}}"></span>
                    <span data-date datetime="{{item.meta.date}}"
                          class="badge badge-light"
                    ></span>
                    <span title="{{item.meta.message}}">{{item.meta.message}}</span>
                  </div>
                </t-else>
              </div>
              <t-if on="item.children">
                <ul>
                  <t-children/>
                </ul>
              </t-if>
            </li>
          </t-tree>
        </ul>
      </div>
    </t-if>
    <div id="content"></div>
  </div>
  <t-include file="./include/footer.html"/>
</div>
<a class="btn btn-dark position-fixed text-light" href="#" style="right: 20px;bottom: 60px;">
  <i class="fa fa-arrow-up"></i>
</a>
<t-if on="!/^\.pdf$/i.test(ext)">
  <script type="text/javascript">
  $(function () {
    $('#content').html('加载中...')
    $.get('/raw/{{userName}}/{{projectName}}/{{file}}').then(function (content, state, xhr) {
      var contentType = xhr.getResponseHeader('content-type')
      if (/text\/html/.test(contentType)) {
        $('#content').html(content)
        return
      }
      // 判断是不是 markdown 文件
      // # `` ** __ _ * > -
      var isMarkdown = content.split('\n').some(function (line) {
        if (/^#+/.test(line)) {
          return true
        }
        if (/`.+?`/.test(line)) {
          return true
        }
        if (/^```/.test(line)) {
          return true
        }
        if (/([*_]{1,2}).+?\1/.test(line)) {
          return true
        }
        if (/^\s*>/.test(line)) {
          return true
        }
        if (/\[.+?]\(.+?\)/.test(line)) {
          return true
        }
        if (/^\|?-+/.test(line)) {
          return true
        }
        return false
      })
      if (!isMarkdown) {
        $('#content').empty().append($('<pre>').text(content))
        return
      }
      marked.setOptions({
        highlight: function (code, language) {
          const validLanguage = hljs.getLanguage(language) ? language : 'plaintext'
          return hljs.highlight(validLanguage, code).value
        }
      })
      var html = marked(content)
      $('#content').html(html).addClass('is-markdown')
    }).catch(e => {
      $('#content').html(`<div class="err text-muted m-5">File ${e.statusText}: <b>{{decodeURI(file)}}</b></div>`)
    })

    var users = {}

    /**
     * 加载用户名和头像
     */
    function getUserInfo(user, callback) {
      if (users[user]) {
        callback(users[user])
        return
      }
      var origin = new URL('{{editUrl}}').origin
      $.post('/proxy/', {
        target: origin + '/api/v1/users/' + user
      }).then(function (response) {
        users[user] = {
          avatar: response.avatar_url,
          name: response.full_name || user
        }
        callback(users[user])
      }).catch(function () {
      })
    }

    // 高亮当前文件
    var current = decodeURI(window.location.pathname)
    var catalog = $('#catalog')
    catalog.find('span[data-user]').each(function () {
      var el = $(this)
      var user = el.attr('data-user')
      el.text(user[0]).attr('title', '用户 ' + user + ' 最后更新')
      getUserInfo(user, function (info) {
        var title = '用户 ' + info.name + ' 最后更新'
        if (info.avatar) {
          el.before($('<img width="16" height="16"' +
            ' style="vertical-align: -3px;margin-right: 2px" title="' +
            title +
            '">')
            .attr('src', info.avatar))
          el.hide()
          return
        }
        el.text(info.name[0]).attr('title', title)
      })
    })
    catalog.find('a[href]').each(function () {
      var link = decodeURI($(this).attr('href'))
      if (link !== current) {
        return
      }
      $(this).removeAttr('href').parent().addClass('active')
      var msg = $(this).next()
      var user = msg.find('span[data-user]')
      $('#update-user').text(user.attr('data-user'))
      var date = user.next()
      $('#update-date').text(date.text())
        .attr('datetime', date.attr('datetime'))
        .attr('title', date.attr('datetime'))
      setTimeout(function () {
        getUserInfo(user.attr('data-user'), function (info) {
          if (info.avatar) {
            $('#update-user')
              .before($('<img width="16" height="16" style="vertical-align: -3px;margin-right: 2px">')
                .attr('src', info.avatar))
          }
          $('#update-user').text(info.name)
        })
      }, 0)
      return false
    })
  })
  </script>
</t-if>
<t-elif on="/^\.pdf$/i.test(ext)">
  <script type="text/javascript">
  $(function () {
    PDFObject.embed('/raw/{{userName}}/{{projectName}}/{{file}}', '#content', {
      fallbackLink: `<p>你用的古董浏览器不支持PDF文件预览，<a href="[url]" target="_blank">下载</a> 后重来。</p>`
    })
  })
  </script>
</t-elif>
</body>
</html>
